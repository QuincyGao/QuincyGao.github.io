<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="背景介绍 kamailio 的dispatcher模块提供负载均衡功能,可以采用轮询,负载上的权重,通话负载分发和哈希方式。 该模块比较轻量，适合高并发场景。但是不能分发REGISTER请求。\n">
<title>kamailio dispatcher介绍</title>

<link rel='canonical' href='https://QuincyGao.github.io/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/'>

<link rel="stylesheet" href="/scss/style.min.259dacd0db0265a40eaf1939ad2454b5535d8dc86e763b6d8fdef4fdd51f27f9.css"><meta property='og:title' content="kamailio dispatcher介绍">
<meta property='og:description' content="背景介绍 kamailio 的dispatcher模块提供负载均衡功能,可以采用轮询,负载上的权重,通话负载分发和哈希方式。 该模块比较轻量，适合高并发场景。但是不能分发REGISTER请求。\n">
<meta property='og:url' content='https://QuincyGao.github.io/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/'>
<meta property='og:site_name' content='QuincyGao Blog'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='kamailio' /><meta property='article:published_time' content='2025-03-27T08:55:38&#43;08:00'/><meta property='article:modified_time' content='2025-03-27T08:55:38&#43;08:00'/><meta property='og:image' content='https://QuincyGao.github.io/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/backup.jpg' />
<meta name="twitter:title" content="kamailio dispatcher介绍">
<meta name="twitter:description" content="背景介绍 kamailio 的dispatcher模块提供负载均衡功能,可以采用轮询,负载上的权重,通话负载分发和哈希方式。 该模块比较轻量，适合高并发场景。但是不能分发REGISTER请求。\n"><meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:image" content='https://QuincyGao.github.io/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/backup.jpg' />
    <link rel="shortcut icon" href="/favicon.png" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="切换菜单">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/QuincyGao_hu9863765197253960442.jpg" width="300"
                            height="225" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">QuincyGao Blog</a></h1>
            <h2 class="site-description">事在人为，境由心造</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://bilibili.com'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" id="Bilibili-Logo--Streamline-Ultimate.svg" height="24" width="24"><desc>Bilibili Logo Streamline Icon: https://streamlinehq.com</desc><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="M4.90263 6.93445H19.0575s1.4674 0 1.4674 1.46739v9.27356s0 1.4673 -1.4674 1.4673H4.90263s-1.46739 0 -1.46739 -1.4673V8.40184s0 -1.46739 1.46739 -1.46739Z" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="M14.7251 15.8387c-0.0599 0.2695 -0.3493 0.6189 -0.9982 0.6189 -1.1779 0 -1.707 -1.4674 -1.707 -1.4674s-0.529 1.4674 -1.7069 1.4674c-0.68879 0 -0.99824 -0.3494 -0.99824 -0.6189" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="M4.65306 4.24927c-1.03607 0.00264 -2.02881 0.41607 -2.76049 1.14962C1.16089 6.13245 0.749997 7.12623 0.75 8.16231V17.925c0 1.0351 0.41121 2.0279 1.14318 2.7598 0.73197 0.732 1.72472 1.1432 2.75988 1.1432h0.99823v0.2196c0.0276 0.3053 0.16838 0.5892 0.39465 0.7959 0.22627 0.2067 0.52168 0.3213 0.82817 0.3213 0.30649 0 0.6019 -0.1146 0.82818 -0.3213 0.22627 -0.2067 0.36704 -0.4906 0.39465 -0.7959v-0.2495h7.80616v0.2495c0.0276 0.3053 0.1683 0.5892 0.3946 0.7959 0.2263 0.2067 0.5217 0.3213 0.8282 0.3213s0.6019 -0.1146 0.8282 -0.3213c0.2262 -0.2067 0.367 -0.4906 0.3946 -0.7959v-0.2495h0.9982c1.0352 0 2.028 -0.4112 2.7599 -1.1432 0.732 -0.732 1.1432 -1.7247 1.1432 -2.7599V8.16231c0 -1.03608 -0.4109 -2.02986 -1.1426 -2.76342 -0.7317 -0.73355 -1.7244 -1.14698 -2.7605 -1.14962H4.65306Z" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="m5.72116 11.6761 3.84317 -0.7786" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="m18.2389 11.6761 -3.8431 -0.7786" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="M6.12045 0.835205 9.53438 4.24914" stroke-width="1.5"></path><path stroke="#000000" stroke-linecap="round" stroke-linejoin="round" d="M17.8396 0.835205 14.4257 4.24914" stroke-width="1.5"></path></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/QuincyGao'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg width="800px" height="800px" viewBox="0 0 20 20" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    
    <title>github [#142]</title>
    <desc>Created with Sketch.</desc>
    <defs>

</defs>
    <g id="Page-1" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Dribbble-Light-Preview" transform="translate(-140.000000, -7559.000000)" fill="#000000">
            <g id="icons" transform="translate(56.000000, 160.000000)">
                <path d="M94,7399 C99.523,7399 104,7403.59 104,7409.253 C104,7413.782 101.138,7417.624 97.167,7418.981 C96.66,7419.082 96.48,7418.762 96.48,7418.489 C96.48,7418.151 96.492,7417.047 96.492,7415.675 C96.492,7414.719 96.172,7414.095 95.813,7413.777 C98.04,7413.523 100.38,7412.656 100.38,7408.718 C100.38,7407.598 99.992,7406.684 99.35,7405.966 C99.454,7405.707 99.797,7404.664 99.252,7403.252 C99.252,7403.252 98.414,7402.977 96.505,7404.303 C95.706,7404.076 94.85,7403.962 94,7403.958 C93.15,7403.962 92.295,7404.076 91.497,7404.303 C89.586,7402.977 88.746,7403.252 88.746,7403.252 C88.203,7404.664 88.546,7405.707 88.649,7405.966 C88.01,7406.684 87.619,7407.598 87.619,7408.718 C87.619,7412.646 89.954,7413.526 92.175,7413.785 C91.889,7414.041 91.63,7414.493 91.54,7415.156 C90.97,7415.418 89.522,7415.871 88.63,7414.304 C88.63,7414.304 88.101,7413.319 87.097,7413.247 C87.097,7413.247 86.122,7413.234 87.029,7413.87 C87.029,7413.87 87.684,7414.185 88.139,7415.37 C88.139,7415.37 88.726,7417.2 91.508,7416.58 C91.513,7417.437 91.522,7418.245 91.522,7418.489 C91.522,7418.76 91.338,7419.077 90.839,7418.982 C86.865,7417.627 84,7413.783 84,7409.253 C84,7403.59 88.478,7399 94,7399" id="github-[#142]">

</path>
            </g>
        </g>
    </g>
</svg>
                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 507.93 507.93" xml:space="preserve">
<g>
	<rect x="103.527" y="225.828" style="fill:#FFFFFF;" width="300.9" height="253.9"/>
	<polygon style="fill:#FFFFFF;" points="53.427,197.528 454.427,197.528 253.927,32.428 	"/>
</g>
<path style="fill:#56ACE0;" d="M253.927,68.928l-20.1,16.6h12.7c7.8,0,14.1,6.3,14.1,14.1s-6.3,14.1-14.1,14.1h-47l-21,17.3h19.9
	c7.8,0,14.1,6.3,14.1,14.1s-6.3,14.1-14.1,14.1h-53.2c-0.3,0-0.5-0.1-0.8-0.1l-12.4,10.2h243.8L253.927,68.928z"/>
<rect x="202.427" y="337.028" style="fill:#FFC10D;" width="103" height="142.6"/>
<path style="fill:#194F82;" d="M501.627,199.828l-238.7-196.6c-5.2-4.3-12.7-4.3-17.9,0l-239.9,197.6c-4.6,3.8-6.3,10-4.3,15.7
	c2,5.6,7.3,9.3,13.3,9.3h61.1v268c0,7.8,6.3,14.1,14.1,14.1h329.2c7.8,0,14.1-6.3,14.1-14.1v-268h61.1c0.1,0,0.1,0,0.1,0
	c7.8,0,14.1-6.3,14.1-14.1C508.027,206.728,505.427,202.328,501.627,199.828z M305.427,479.628h-103v-142.6h103V479.628z
	 M404.427,479.628h-70.8v-156.7c0-7.8-6.3-14.1-14.1-14.1h-131.2c-7.8,0-14.1,6.3-14.1,14.1v156.7h-70.8v-253.8h300.9v253.8H404.427
	z M53.427,197.528l200.5-165.1l200.5,165.2h-401V197.528z"/>
</svg>
                
                <span>首页</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 392.598 392.598" xml:space="preserve">
<path style="fill:#FFFFFF;" d="M76.412,326.853h85.075c6.012,0,10.925-4.848,10.925-10.925V32.97
	c0-6.012-4.848-10.925-10.925-10.925H76.412c-6.012,0-10.925,4.848-10.925,10.925v282.958
	C65.487,322.004,70.4,326.853,76.412,326.853z"/>
<path style="fill:#FFC10D;" d="M231.564,326.853h85.075c5.107,0,9.374-3.556,10.602-8.275l0.388-285.608
	c0-6.012-4.848-10.925-10.925-10.925h-85.139c-6.012,0-10.925,4.848-10.925,10.925v282.958
	C220.574,322.004,225.552,326.853,231.564,326.853z"/>
<g>
	<path style="fill:#FFFFFF;" d="M118.885,255.677c-5.43,0-9.826,4.396-9.826,9.826c0,5.43,4.396,9.826,9.826,9.826
		c5.43,0,9.826-4.396,9.826-9.826C128.711,260.073,124.315,255.677,118.885,255.677z"/>
	<path style="fill:#FFFFFF;" d="M274.036,255.677c-5.43,0-9.826,4.396-9.826,9.826c0,5.43,4.396,9.826,9.826,9.826
		c5.43,0,9.826-4.396,9.826-9.826C283.863,260.073,279.467,255.677,274.036,255.677z"/>
</g>
<g>
	<path style="fill:#194F82;" d="M118.885,296.921c17.455,0,31.612-14.222,31.612-31.612c0-17.455-14.222-31.612-31.612-31.612
		s-31.612,14.222-31.612,31.612C87.273,282.828,101.495,296.921,118.885,296.921z M118.885,255.547c5.43,0,9.826,4.396,9.826,9.826
		s-4.396,9.826-9.826,9.826c-5.43,0-9.826-4.396-9.826-9.826S113.519,255.547,118.885,255.547z"/>
	<path style="fill:#194F82;" d="M98.198,87.143h41.438c6.012,0,10.925-4.848,10.925-10.925c0-6.012-4.848-10.925-10.925-10.925
		H98.198c-6.012,0-10.925,4.848-10.925,10.925C87.273,82.295,92.186,87.143,98.198,87.143z"/>
	<path style="fill:#194F82;" d="M98.198,140.994h41.438c6.012,0,10.925-4.848,10.925-10.925c0-6.012-4.848-10.925-10.925-10.925
		H98.198c-6.012,0-10.925,4.848-10.925,10.925C87.273,136.145,92.186,140.994,98.198,140.994z"/>
	<path style="fill:#194F82;" d="M274.036,296.921c17.455,0,31.612-14.222,31.612-31.612c0-17.455-14.222-31.612-31.612-31.612
		s-31.612,14.222-31.612,31.612C242.489,282.828,256.582,296.921,274.036,296.921z M274.036,255.547c5.43,0,9.826,4.396,9.826,9.826
		s-4.396,9.826-9.826,9.826c-5.43,0-9.826-4.396-9.826-9.826C264.275,259.943,268.671,255.547,274.036,255.547z"/>
	<path style="fill:#194F82;" d="M253.35,87.143h41.438c6.012,0,10.925-4.848,10.925-10.925c0-6.012-4.848-10.925-10.925-10.925
		H253.35c-6.012,0-10.925,4.848-10.925,10.925C242.489,82.295,247.337,87.143,253.35,87.143z"/>
	<path style="fill:#194F82;" d="M253.35,140.994h41.438c6.012,0,10.925-4.848,10.925-10.925c0-6.012-4.848-10.925-10.925-10.925
		H253.35c-6.012,0-10.925,4.848-10.925,10.925C242.489,136.145,247.337,140.994,253.35,140.994z"/>
	<path style="fill:#194F82;" d="M381.737,203.378h-32.388V32.97c0-18.036-14.675-32.711-32.711-32.711h-85.075
		c-18.036,0-32.711,14.675-32.711,32.711v282.958c0,3.879,0.711,7.499,1.939,10.925h-8.404c1.228-3.426,1.939-7.111,1.939-10.925
		V32.97c0-18.036-14.675-32.711-32.711-32.711H76.412c-18.036,0-32.711,14.675-32.711,32.711v170.473H10.925
		C4.913,203.442,0,208.291,0,214.368v167.046c0,6.012,4.848,10.925,10.925,10.925h370.747c6.012,0,10.925-4.848,10.925-10.925
		V214.368C392.598,208.291,387.749,203.378,381.737,203.378z M220.574,32.97c0-6.012,4.848-10.925,10.925-10.925h85.075
		c6.012,0,10.925,4.848,10.925,10.925l-0.388,285.608c-1.164,4.719-5.43,8.275-10.602,8.275h-84.945
		c-6.012,0-10.925-4.848-10.925-10.925V32.97H220.574z M65.487,32.97c0-6.012,4.848-10.925,10.925-10.925h85.075
		c6.012,0,10.925,4.848,10.925,10.925v282.958c0,6.012-4.848,10.925-10.925,10.925H76.412c-6.012,0-10.925-4.848-10.925-10.925
		C65.487,315.992,65.487,32.97,65.487,32.97z M370.812,370.424H21.851V225.164h21.786v112.485c0,6.012,4.848,10.925,10.925,10.925
		h283.539c6.012,0,10.925-4.848,10.925-10.925l0.388-112.485h21.463v145.261H370.812z"/>
</g>
<path style="fill:#56ACE0;" d="M349.026,337.778c0,6.012-4.848,10.925-10.925,10.925H54.626c-6.012,0-10.925-4.848-10.925-10.925
	V225.293H21.851v145.261h348.962V225.228h-21.463L349.026,337.778z"/>
</svg>
                
                <span>归档</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 392.609 392.609" xml:space="preserve">
<path style="fill:#FFFFFF;" d="M273.713,147.774c0,69.495-56.501,125.931-125.931,125.931c-69.495,0-125.931-56.501-125.931-125.931
	c0-69.495,56.501-125.931,125.931-125.931C217.212,21.843,273.713,78.344,273.713,147.774z"/>
<path style="fill:#56ACE0;" d="M370.747,348.695c0,1.422-1.616,6.271-7.176,12.283c-6.206,6.659-12.477,9.762-14.739,9.762h-0.065
	c-19.459-1.616-61.996-43.184-109.576-106.796c0-0.065,0-0.065,0-0.129c9.18-7.24,17.455-15.515,24.63-24.63
	c0.065,0,0.065,0,0.129,0C327.564,286.699,369.131,329.301,370.747,348.695z"/>
<path style="fill:#FFC10D;" d="M208.679,86.877l-14.481,14.481c-17.131,17.131-46.545,5.042-46.545-19.265V61.6
	c-49.002,0-88.372,40.792-86.109,90.246c2.004,43.895,38.141,80.032,82.036,82.036c49.455,2.263,90.246-37.172,90.246-86.109
	C233.956,124.049,224.323,102.522,208.679,86.877z"/>
<path style="fill:#194F82;" d="M276.105,220.954c12.347-21.527,19.459-46.545,19.459-73.18c0-81.455-66.327-147.717-147.846-147.717
	S0,66.32,0,147.904s66.327,147.717,147.717,147.717c26.57,0,51.523-7.111,73.18-19.459
	c39.822,53.333,91.863,113.519,126.061,116.364c12.283,0.517,22.885-6.723,32.776-16.743c5.172-5.624,13.77-16.937,12.8-28.768
	C389.624,312.881,329.438,260.776,276.105,220.954z M147.717,273.77c-69.495,0-125.931-56.501-125.931-125.931
	S78.287,21.908,147.717,21.908s125.931,56.501,125.931,125.931S217.212,273.77,147.717,273.77z M363.572,360.978
	c-6.206,6.659-12.412,9.762-14.739,9.762h-0.065c-19.459-1.616-61.996-43.184-109.576-106.796c0-0.065,0-0.065,0-0.129
	c9.18-7.24,17.455-15.515,24.63-24.63c0.065,0,0.065,0,0.129,0c63.612,47.58,105.18,90.182,106.796,109.576
	C370.747,350.118,369.131,354.966,363.572,360.978z"/>
</svg>
                
                <span>搜索</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E9%93%BE/' >
                
                
                
                    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 392.598 392.598" xml:space="preserve">
<path style="fill:#56ACE0;" d="M120.469,49.455c0,15.257-12.412,27.669-27.669,27.669c-15.192,0-27.669-12.412-27.669-27.669
	S77.543,21.786,92.8,21.786C108.057,21.786,120.469,34.198,120.469,49.455z"/>
<path style="fill:#FFFFFF;" d="M62.287,265.503h61.026v105.244h-19.588v-42.861c0-6.012-4.848-10.925-10.925-10.925
	c-6.012,0-10.925,4.849-10.925,10.925v42.861H62.287V265.503z"/>
<path style="fill:#FFC10D;" d="M144.129,181.657v62.061H41.471v-62.061c0-25.277,20.558-45.834,45.834-45.834h10.99
	C123.572,135.822,144.129,156.38,144.129,181.657z"/>
<path style="fill:#FFFFFF;" d="M272.129,49.455c0-15.257,12.412-27.669,27.669-27.669c15.257,0,27.669,12.412,27.669,27.669
	s-12.412,27.669-27.669,27.669C284.606,77.123,272.129,64.711,272.129,49.455z"/>
<path style="fill:#FFC10D;" d="M269.156,265.503h61.026v105.244h-19.523v-42.861c0-6.012-4.848-10.925-10.925-10.925
	c-6.077,0-10.925,4.849-10.925,10.925v42.861h-19.653L269.156,265.503L269.156,265.503z"/>
<path style="fill:#56ACE0;" d="M351.127,181.657v62.061H248.469v-62.061c0-25.277,20.558-45.834,45.834-45.834h10.99
	C330.57,135.822,351.127,156.38,351.127,181.657z"/>
<g>
	<path style="fill:#194F82;" d="M98.295,113.972h-10.99c-37.301,0-67.685,30.384-67.685,67.685v72.921
		c0,6.012,4.848,10.925,10.925,10.925h9.891v116.17c0,6.012,4.848,10.925,10.925,10.925h82.877c6.012,0,10.925-4.848,10.925-10.925
		v-116.17h9.891c6.012,0,10.925-4.848,10.925-10.925v-72.921C165.98,144.356,135.661,113.972,98.295,113.972z M144.129,243.717
		H41.471v-62.061c0-25.277,20.558-45.834,45.834-45.834h10.99c25.277,0,45.834,20.558,45.834,45.834L144.129,243.717
		L144.129,243.717z M123.378,370.747h-19.653v-42.861c0-6.012-4.848-10.925-10.925-10.925c-6.012,0-10.925,4.849-10.925,10.925
		v42.861H62.287V265.503h61.026L123.378,370.747L123.378,370.747z"/>
	<path style="fill:#194F82;" d="M92.8,0C65.519,0,43.281,22.174,43.281,49.455s22.174,49.455,49.455,49.455
		s49.455-22.174,49.455-49.455S120.081,0,92.8,0z M92.8,77.123c-15.192,0-27.669-12.412-27.669-27.669S77.543,21.786,92.8,21.786
		s27.669,12.412,27.669,27.669S108.057,77.123,92.8,77.123z"/>
	<path style="fill:#194F82;" d="M305.228,113.972h-10.99c-37.301,0-67.685,30.384-67.685,67.685v72.921
		c0,6.012,4.848,10.925,10.925,10.925h9.891v116.17c0,6.012,4.848,10.925,10.925,10.925h82.941c6.012,0,10.925-4.848,10.925-10.925
		v-116.17h9.891c6.012,0,10.925-4.848,10.925-10.925v-72.921C372.913,144.356,342.594,113.972,305.228,113.972z M351.127,243.717
		H248.469v-62.061c0-25.277,20.558-45.834,45.834-45.834h10.99c25.277,0,45.834,20.558,45.834,45.834V243.717L351.127,243.717z
		 M330.311,370.747h-19.653v-42.861c0-6.012-4.848-10.925-10.925-10.925c-6.077,0-10.925,4.849-10.925,10.925v42.861h-19.653
		V265.503h61.026v105.244H330.311z"/>
	<path style="fill:#194F82;" d="M299.798,0c-27.281,0-49.455,22.174-49.455,49.455s22.174,49.455,49.455,49.455
		s49.455-22.174,49.455-49.455S327.014,0,299.798,0z M299.798,77.123c-15.192,0-27.669-12.412-27.669-27.669
		s12.412-27.669,27.669-27.669s27.669,12.412,27.669,27.669S315.055,77.123,299.798,77.123z"/>
</g>
</svg>
                
                <span>友链</span>
            </a>
        </li>
        
        
        <li >
            <a href='/about/' >
                
                
                
                    <?xml version="1.0" encoding="iso-8859-1"?>
<!-- Uploaded to: SVG Repo, www.svgrepo.com, Generator: SVG Repo Mixer Tools -->
<svg height="800px" width="800px" version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" 
	 viewBox="0 0 392.533 392.533" xml:space="preserve">
<path style="fill:#FFFFFF;" d="M196.267,21.851c-96.194,0-174.481,78.287-174.481,174.481s78.287,174.481,174.481,174.481
	s174.481-78.287,174.481-174.481S292.461,21.851,196.267,21.851z"/>
<path style="fill:#FFC10D;" d="M196.267,348.962c-84.17,0-152.695-68.461-152.695-152.695s68.525-152.63,152.695-152.63
	s152.695,68.461,152.695,152.695S280.436,348.962,196.267,348.962z"/>
<path style="fill:#FFFFFF;" d="M131.814,125.543c-8.21,0-14.933,6.723-14.933,14.933s6.723,14.933,14.933,14.933
	c8.21,0,14.933-6.723,14.933-14.933C146.747,132.267,140.024,125.543,131.814,125.543z"/>
<path style="fill:#194F82;" d="M131.814,103.758c-20.234,0-36.719,16.485-36.719,36.719s16.485,36.719,36.719,36.719
	s36.719-16.485,36.719-36.719S152.048,103.758,131.814,103.758z M131.814,155.41c-8.21,0-14.933-6.723-14.933-14.933
	c0-8.21,6.723-14.933,14.933-14.933c8.21,0,14.933,6.723,14.933,14.933C146.747,148.752,140.024,155.41,131.814,155.41z"/>
<path style="fill:#FFFFFF;" d="M260.719,125.543c-8.21,0-14.933,6.723-14.933,14.933s6.723,14.933,14.933,14.933
	s14.933-6.723,14.933-14.933S268.994,125.543,260.719,125.543z"/>
<g>
	<path style="fill:#194F82;" d="M260.719,103.758c-20.234,0-36.719,16.485-36.719,36.719s16.485,36.719,36.719,36.719
		c20.234,0,36.719-16.485,36.719-36.719S280.954,103.758,260.719,103.758z M260.719,155.41c-8.21,0-14.933-6.723-14.933-14.933
		c0-8.21,6.723-14.933,14.933-14.933s14.933,6.723,14.933,14.933C275.653,148.752,268.994,155.41,260.719,155.41z"/>
	<path style="fill:#194F82;" d="M196.267,0C87.984,0,0,87.984,0,196.267s87.984,196.267,196.267,196.267
		s196.267-87.984,196.267-196.267S304.549,0,196.267,0z M196.267,370.747c-96.194,0-174.481-78.287-174.481-174.481
		S100.073,21.786,196.267,21.786s174.481,78.287,174.481,174.481S292.461,370.747,196.267,370.747z"/>
	<path style="fill:#194F82;" d="M279.079,265.051c-45.64,45.64-119.984,45.64-165.689,0c-4.267-4.267-11.119-4.202-15.451,0
		c-4.848,4.719-3.943,10.99,0,15.451c55.661,55.467,143.515,53.075,196.525,0c3.685-4.784,5.042-10.731,0-15.451
		C290.133,260.913,283.345,260.784,279.079,265.051z"/>
</g>
</svg>
                
                <span>关于我</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">
                    
                        <li id="i18n-switch">  
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                            <select name="language" title="language" onchange="window.location.href = this.selectedOptions[0].value">
                                
                                    <option value="https://QuincyGao.github.io/" selected>Chinese</option>
                                
                                    <option value="https://QuincyGao.github.io/en/" >English</option>
                                
                            </select>
                        </li>
                    
                

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>暗色模式</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">目录</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#背景介绍">背景介绍</a></li>
    <li><a href="#重要参数解析">重要参数解析</a></li>
    <li><a href="#重要函数">重要函数</a>
      <ol>
        <li><a href="#ds_select_dstset-alg-limit">ds_select_dst(set, alg[, limit])</a></li>
        <li><a href="#ds_next_dst">ds_next_dst()</a></li>
        <li><a href="#ds_set_dst">ds_set_dst()</a></li>
        <li><a href="#ds_select_domainset-alg-limit">ds_select_domain(set, alg[, limit])</a></li>
        <li><a href="#ds_next_domain">ds_next_domain()</a></li>
        <li><a href="#ds_set_domain">ds_set_domain()</a></li>
        <li><a href="#ds_selectset-alg-limit">ds_select(set, alg[, limit])</a></li>
        <li><a href="#ds_select_routesrules-mode--limit">ds_select_routes(rules, mode [, limit])</a></li>
        <li><a href="#ds_mark_dststate">ds_mark_dst([state])</a></li>
      </ol>
    </li>
    <li><a href="#实战">实战</a>
      <ol>
        <li><a href="#从文件读取">从文件读取</a></li>
        <li><a href="#测试效果">测试效果</a>
          <ol>
            <li><a href="#ping">ping</a></li>
            <li><a href="#正常拨打电话">正常拨打电话</a></li>
            <li><a href="#当其中一个节点停掉">当其中一个节点停掉</a></li>
          </ol>
        </li>
        <li><a href="#存在的问题">存在的问题</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="has-image main-article">
    <header class="article-header">
        <div class="article-image">
            <a href="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/">
                <img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/backup_hu4797976030433285173.jpg"
                        srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/backup_hu4797976030433285173.jpg 800w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/backup_hu15371183197446639369.jpg 1600w"
                        width="800" 
                        height="422" 
                        loading="lazy"
                        alt="Featured image of post kamailio dispatcher介绍" />
                
            </a>
        </div>
    

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/kamailio/" style="background-color: #d09daa; color: #fff;">
                kamailio
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/">kamailio dispatcher介绍</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">2025-03-27</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    阅读时长: 6 分钟,共2737 字
                </time>
            </div>
        
        <div>
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-eye"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" /><path d="M21 12c-2.4 4 -5.4 6 -9 6c-3.6 0 -6.6 -2 -9 -6c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6" /></svg>
            <time class="article-pageview">
                <span class="waline-pageview-count" data-path="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/">0</span> 次浏览
            </time>
        </div>
    
        <div>
            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-message-dots"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 11v.01" /><path d="M8 11v.01" /><path d="M16 11v.01" /><path d="M18 4a3 3 0 0 1 3 3v8a3 3 0 0 1 -3 3h-5l-5 3v-3h-2a3 3 0 0 1 -3 -3v-8a3 3 0 0 1 3 -3z" /></svg>
            <time class="article-comment">
                <span class="waline-comment-count" data-path="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/">0</span> 条评论
            </time>
        </div>
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h2 id="背景介绍">背景介绍
</h2><p>kamailio 的dispatcher模块提供负载均衡功能,可以采用轮询,负载上的权重,通话负载分发和哈希方式。
该模块比较轻量，适合高并发场景。但是不能分发<code>REGISTER</code>请求。</p>
<p>它和<code>opensips</code>的<code>dispatcher</code>不一样,opensips的<code>dispatcher</code>可以分发<code>REGISTER</code>请求。
它更像是opensips的<code>load_balancer</code>。</p>
<p>这个模块既可以使用数据库，也可以使用文件来配置。官方文档地址:<a class="link" href="https://kamailio.org/docs/modules/5.8.x/modules/dispatcher.html"  target="_blank" rel="noopener"
    >dispatcher</a></p>
<p>kamailio的版本:</p>
<blockquote>
<p>version: kamailio 5.8.5 (x86_64/linux)</p>
</blockquote>
<h2 id="重要参数解析">重要参数解析
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="c1"># 设置dispatcher配置加载的文件</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;list_file&#34;</span><span class="p">,</span> <span class="s2">&#34;/run/kamailio/dispatcher.list&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置从数据库中加载dispather配置,默认NULL,不从数据库加载</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;db_url&#34;</span><span class="p">,</span> <span class="s2">&#34;mysql://user:passwd@localhost/kamailio&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 确定分发的方式，是位掩码,默认0,使用username,hostname,port来计算URI哈希;1,使用username计算URI哈希;2,分发失败后,可以尝试下一个地址。 </span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;flags&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 目的地址集的最后一个地址作为发送地址,默认0</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;use_default&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1">#存储分发地址的AVP变量名,默认: _dsdst_</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;xavp_dst&#34;</span><span class="p">,</span> <span class="s2">&#34;_dsdst_&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 控制哪些参数存XAVP_DST里,</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;xavp_dst_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ping方式,默认: OPTIONS</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_method&#34;</span><span class="p">,</span> <span class="s2">&#34;OPTIONS&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping的from地址</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_from&#34;</span><span class="p">,</span> <span class="s2">&#34;sip:proxy@sip.somehost.com&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping的时间间隔,默认0, 不能ping</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_interval&#34;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping使用的地址,必须提前监听</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_default_socket&#34;</span><span class="p">,</span> <span class="s2">&#34;udp:192.168.0.125:5060&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># ping失败多少次数后,把gateway标记为不可用,默认1</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_probing_threshold&#34;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># gateway从不活跃状态恢复到活跃态,需要ping多少次,默认1</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_inactive_threshold&#34;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 定义合法的ping响应码,默认:&#34;&#34;,只接受200OK</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_reply_codes&#34;</span><span class="p">,</span> <span class="s2">&#34;class=2;code=403;code=488;class=3&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0, 只有PROBING状态的gateway会ping;1, 所有gateway都会ping;</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 2,只有INACTIVE状态并且处于PROBING的gateway会ping;3,持续探测任何状态为PROBING的gateway</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_probing_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 设置定时器进程的运行模式,0, 使用主定时器;1,使用次定时器。</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_timer_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当gateway配置错误时,1,报错;2,跳过错误的gateway,继续下一个</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_load_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 当重新加载dispatcher配置时,延迟多少秒,默认5s</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;reload_delta&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="重要函数">重要函数
</h2><h3 id="ds_select_dstset-alg-limit">ds_select_dst(set, alg[, limit])
</h3><p>从地址集中选择一个地址，然后把地址设置到<code>$du</code>,</p>
<ul>
<li>set
表dispatcher的<code>setid</code></li>
<li>alg
负载均衡算法,可多个叠加:
<ul>
<li>&ldquo;0&rdquo;: 哈希<code>callid</code></li>
<li>&ldquo;1&rdquo;: 哈希<code>from URI</code></li>
<li>&ldquo;2&rdquo;: 哈希<code>to URI</code></li>
<li>&ldquo;3&rdquo;: 哈希<code>request-URI user</code></li>
<li>&ldquo;4&rdquo;: 轮询</li>
<li>&ldquo;5&rdquo;: 哈希<code>authorization-username</code>,如果没有此字段,使用<code>轮询</code></li>
<li>&ldquo;6&rdquo;: 随机</li>
<li>&ldquo;7&rdquo;: 哈希<code>PVs</code>,必须设置<code>hash_pvar</code></li>
<li>&ldquo;8&rdquo;: 使用<code>dispatcher</code>表里按照<code>priority</code>排序的gateway</li>
<li>&ldquo;9&rdquo;: <code>权重分发</code>，使用<code>dispatcher</code>表里按照<code>weight</code>排序的gateway</li>
<li>&ldquo;10&rdquo;: 使用<code>通话负载分发</code>,必须设置<code>ds_hash_size</code>和<code>dispatcher</code>表的<code>attrs</code>添加<code>duid</code>,速度很快</li>
<li>&ldquo;11&rdquo;: 使用<code>相对权重分发</code>, <code>dispatcher</code>表的<code>attrs</code>添加<code>rweight</code>, 相对于<code>权重分发</code>,如果有gateway不活跃了,每次会重新计算权重</li>
<li>&ldquo;12&rdquo;: 分发所有节点</li>
<li>&ldquo;13&rdquo;: 延迟分发<code>ds_ping_latency_stats</code>, 使用的是轮询分发</li>
</ul>
</li>
</ul>
<h3 id="ds_next_dst">ds_next_dst()
</h3><p>获取下一个地址,并设置<code>$du</code>。</p>
<h3 id="ds_set_dst">ds_set_dst()
</h3><p>把当前的地址设置为<code>$du</code>。</p>
<h3 id="ds_select_domainset-alg-limit">ds_select_domain(set, alg[, limit])
</h3><p>从地址集中选择一个地址,然后重写<code>R-URI</code>里的<code>host</code>和<code>Port</code>,其他参数和<code>ds_select_dst</code>一致。</p>
<h3 id="ds_next_domain">ds_next_domain()
</h3><p>获取下一个地址,并设置<code>R-URI</code>。</p>
<h3 id="ds_set_domain">ds_set_domain()
</h3><p>把当前的地址设置为<code>R-URI</code>。</p>
<h3 id="ds_selectset-alg-limit">ds_select(set, alg[, limit])
</h3><p>从地址集中选择一个地址,存在XAVP变量里,不会重写<code>R-URI</code>和<code>$du</code></p>
<h3 id="ds_select_routesrules-mode--limit">ds_select_routes(rules, mode [, limit])
</h3><p>按照规则从地址集中选择一个地址</p>
<ul>
<li>rules
匹配规则,格式为<code>grp1=alg1;grp2=alg2</code></li>
<li>mode
选择的地址推到哪里
<ul>
<li>&lsquo;0&rsquo;,&rsquo;d&rsquo;,&lsquo;D&rsquo;: 修改$du</li>
<li>&lsquo;1&rsquo;,&lsquo;r&rsquo;,&lsquo;R&rsquo;: 修改R-URI</li>
<li>&lsquo;2&rsquo;,&lsquo;x&rsquo;,&lsquo;X&rsquo;: 存储在XAVP变量</li>
</ul>
</li>
</ul>
<h3 id="ds_mark_dststate">ds_mark_dst([state])
</h3><p>标记上次使用的地址状态</p>
<ul>
<li>state
<ul>
<li>&ldquo;a&rdquo;,&ldquo;A&rdquo;: 活跃状态</li>
<li>&ldquo;i&rdquo;,&ldquo;I&rdquo;: 非活跃状态</li>
<li>&ldquo;t&rdquo;,&ldquo;T&rdquo;: 尝试状态</li>
<li>&ldquo;p&rdquo;,&ldquo;P&rdquo;: 可探测状态</li>
</ul>
</li>
</ul>
<h2 id="实战">实战
</h2><p>本次测试的场景是:</p>
<ol>
<li>软电话1008注册到freeswitch A(<code>172.18.11.187</code>)上, A配置网关转发请求到kamailio (<code>172.16.4.111</code>)</li>
<li>1008拨打1003, kamailio(<code>172.16.4.111</code>)收到请求, dispatcher分发给freeswitch B(<code>172.16.4.113</code>)或 freeswitch C(<code>172.16.4.114</code>)</li>
<li>两个软电话分别向freeswitch B和freeswitch C注册1003</li>
<li>B或者C收到请求,拨打软电话,电话接通</li>
</ol>
<h3 id="从文件读取">从文件读取
</h3><ol>
<li>dispatcher.list</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># setid(int) destination(sip uri) flags(int,opt) priority(int,opt) attributes(str,opt)
</span></span><span class="line"><span class="cl">1 sip:172.16.4.114:5060 0 5 class=4;socket=udp:172.16.4.111:5460;pipe=p10
</span></span><span class="line"><span class="cl">1 sip:172.16.4.113:5060 0 5 class=4;socket=udp:172.16.4.111:5460;pipe=p10
</span></span></code></pre></td></tr></table>
</div>
</div><p>这里要介绍一下<code>attributes</code>参数:</p>
<ul>
<li>class=4
接受错误码为400~499的响应</li>
<li>strip=3
从被叫号码（R-URI）中去除前3位</li>
<li>prefix=86
在被叫号码（R-URI）前加上86</li>
<li>duid=abc
唯一标识目标节点</li>
<li>maxload=30
最大负载值，超过则拒绝</li>
<li>weight=5
1~100,权重，总和为100，权重越大,请求越多</li>
<li>rweight=5
1~100,相对权重，总和为100</li>
<li>socket=udp:127.0.0.1:5060
定义分发请求的socket,覆盖<code>ds_default_socket</code></li>
<li>socketname=xxx
定义分发请求的socket name</li>
<li>ping_from
定义ping的<code>From</code> URI,覆盖<code>ds_ping_from</code></li>
<li>obproxy</li>
<li>latency</li>
</ul>
<ol start="2">
<li>配置示例:</li>
</ol>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">listen</span><span class="o">=</span><span class="n">udp</span><span class="p">:</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">4.111</span><span class="p">:</span><span class="mi">5460</span>
</span></span><span class="line"><span class="cl"><span class="n">listen</span><span class="o">=</span><span class="n">udp</span><span class="p">:</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">4.111</span><span class="p">:</span><span class="mi">5461</span>
</span></span><span class="line"><span class="cl"><span class="n">listen</span><span class="o">=</span><span class="n">udp</span><span class="p">:</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">4.111</span><span class="p">:</span><span class="mi">5464</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">loadmodule</span> <span class="s2">&#34;dispatcher.so&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;list_file&#34;</span><span class="p">,</span> <span class="s2">&#34;/usr/local/etc/kamailio/dispatcher.list&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;xavp_dst&#34;</span><span class="p">,</span> <span class="s2">&#34;_dsdst_&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;xavp_ctx&#34;</span><span class="p">,</span> <span class="s2">&#34;_dsctx_&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;flags&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_method&#34;</span><span class="p">,</span> <span class="s2">&#34;OPTIONS&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_from&#34;</span><span class="p">,</span> <span class="s2">&#34;sip:proxy@172.16.4.111&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_ping_interval&#34;</span><span class="p">,</span> <span class="mi">30</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_default_socket&#34;</span><span class="p">,</span> <span class="s2">&#34;udp:172.16.4.111:5461&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_timer_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_probing_threshold&#34;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_inactive_threshold&#34;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_probing_mode&#34;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">modparam</span><span class="p">(</span><span class="s2">&#34;dispatcher&#34;</span><span class="p">,</span> <span class="s2">&#34;ds_hash_size&#34;</span><span class="p">,</span> <span class="mi">9</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="n">request_route</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">...</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">(</span><span class="n">REGISTRAR</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">$</span><span class="n">rU</span><span class="o">==$</span><span class="n">null</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># request with no Username in RURI</span>
</span></span><span class="line"><span class="cl">            <span class="n">sl_send_reply</span><span class="p">(</span><span class="s2">&#34;484&#34;</span><span class="p">,</span> <span class="s2">&#34;Address Incomplete&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">route</span><span class="p">(</span><span class="n">DISPATCH</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># dispatch destinations to PSTN</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#route(PSTN);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># user location service</span>
</span></span><span class="line"><span class="cl">    <span class="c1">#route(LOCATION);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">route</span><span class="p">[</span><span class="n">DISPATCH</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># round robin dispatching on gateways group &#39;1&#39;</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">ds_select_dst</span><span class="p">(</span><span class="s2">&#34;1&#34;</span><span class="p">,</span> <span class="s2">&#34;4&#34;</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">send_reply</span><span class="p">(</span><span class="s2">&#34;404&#34;</span><span class="p">,</span> <span class="s2">&#34;No destination&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">xlog</span><span class="p">(</span><span class="s2">&#34;L_INFO&#34;</span><span class="p">,</span> <span class="s2">&#34;----- going to $ru via $du (attrs: $xavp(_dsdst_=&gt;attrs))</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">t_on_failure</span><span class="p">(</span><span class="s2">&#34;RTF_DISPATCH&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">route</span><span class="p">(</span><span class="n">RELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">failure_route</span><span class="p">[</span><span class="n">RTF_DISPATCH</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">t_is_canceled</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># next DST - only for 500 or local timeout</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">t_check_status</span><span class="p">(</span><span class="s2">&#34;500&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="ow">or</span> <span class="p">(</span><span class="n">t_branch_timeout</span><span class="p">()</span> <span class="ow">and</span> <span class="o">!</span><span class="n">t_branch_replied</span><span class="p">()))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span><span class="p">(</span><span class="n">ds_next_dst</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="n">xlog</span><span class="p">(</span><span class="s2">&#34;L_INFO&#34;</span><span class="p">,</span><span class="s2">&#34;--- SCRIPT: retrying to &lt;$ru&gt; via &lt;$du&gt; (attrs: $xavp(_dsdst_=&gt;attrs))</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">t_on_failure</span><span class="p">(</span><span class="s2">&#34;RTF_DISPATCH&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">route</span><span class="p">(</span><span class="n">RELAY</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">                        <span class="n">exit</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">event_route</span><span class="p">[</span><span class="n">dispatcher</span><span class="p">:</span><span class="n">dst</span><span class="o">-</span><span class="n">down</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">xlog</span><span class="p">(</span><span class="s2">&#34;L_ERR&#34;</span><span class="p">,</span> <span class="s2">&#34;-----------------Destination down: $rm $ru ($du)</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">event_route</span><span class="p">[</span><span class="n">dispatcher</span><span class="p">:</span><span class="n">dst</span><span class="o">-</span><span class="n">up</span><span class="p">]</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">xlog</span><span class="p">(</span><span class="s2">&#34;L_ERR&#34;</span><span class="p">,</span> <span class="s2">&#34;-----------------Destination up: $rm $ru</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="测试效果">测试效果
</h3><h4 id="ping">ping
</h4><p>kamailio 分别往两个节点发送<code>OPTIONS</code>请求</p>
<ol>
<li>172.16.4.113机器:
<img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip.png"
	width="1592"
	height="372"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip_hu16558076990053910234.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip_hu6311973092583376930.png 1024w"
	loading="lazy"
	
		alt="113"
	
	
		class="gallery-image" 
		data-flex-grow="427"
		data-flex-basis="1027px"
	
></li>
<li>172.16.4.114机器:
<img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip1.png"
	width="1568"
	height="382"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip1_hu14128295669003759215.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip1_hu8118284752908695770.png 1024w"
	loading="lazy"
	
		alt="114"
	
	
		class="gallery-image" 
		data-flex-grow="410"
		data-flex-basis="985px"
	
></li>
</ol>
<h4 id="正常拨打电话">正常拨打电话
</h4><p><img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip2.png"
	width="1597"
	height="1041"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip2_hu10866641951632001069.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip2_hu3110478910891954963.png 1024w"
	loading="lazy"
	
		alt="113"
	
	
		class="gallery-image" 
		data-flex-grow="153"
		data-flex-basis="368px"
	
>
<img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip3.png"
	width="1611"
	height="641"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip3_hu723502701475311109.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip3_hu8990045213888383462.png 1024w"
	loading="lazy"
	
		alt="114"
	
	
		class="gallery-image" 
		data-flex-grow="251"
		data-flex-basis="603px"
	
>
可以看到<code>ds_select_dst</code>配置的是<code>轮询</code>,所以不管第一通<code>172.16.4.113</code>是否接通,第二通都会转到172.16.4.114节点</p>
<p><strong>注意</strong>: 一定不要配置<code>modparam(&quot;dispatcher&quot;, &quot;use_default&quot;, 1)</code>, 否则不管配置的策略是什么,都只会往一个节点发送请求。</p>
<h4 id="当其中一个节点停掉">当其中一个节点停掉
</h4><p>停掉<code>172.16.4.113</code>节点的freeswitch,在<code>dispatcher</code>未标记此节点为<code>非活跃状态</code>之前，请求还是会发往此节点的。
<img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip5.png"
	width="1584"
	height="927"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip5_hu13483282755402287344.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip5_hu3353055856929133160.png 1024w"
	loading="lazy"
	
		alt="113"
	
	
		class="gallery-image" 
		data-flex-grow="170"
		data-flex-basis="410px"
	
></p>
<p><code>dispatcher</code>标记<code>172.16.4.113</code>状态为<code>非活跃状态</code>之后，所有的请求只会转到<code>172.16.4.114</code>节点。
<img src="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip4.png"
	width="1589"
	height="82"
	srcset="/p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip4_hu13891571820473093050.png 480w, /p/kamailio-dispatcher%E4%BB%8B%E7%BB%8D/sip4_hu13667030661612138245.png 1024w"
	loading="lazy"
	
		alt="113"
	
	
		class="gallery-image" 
		data-flex-grow="1937"
		data-flex-basis="4650px"
	
></p>
<h3 id="存在的问题">存在的问题
</h3><p><code>dispatcher</code>模块目前没有找到配置可以让服务一启动就开始<code>ping</code>节点。
这就会导致服务启动后，在<code>ping</code>的定时器开始之前，如果有请求过来，不会分发请求。</p>
<p>当然可以缩短<code>ds_ping_interval</code>间隔，但是这样的话，<code>ping</code>的频率会变高。</p>

</section>


    
<footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/kamailio/">Kamailio</a>
        
    </section>

    
    
		
		
			<div style="padding: 10px 0; margin: 20px auto; width: 100%; font-size:16px; text-align: center;">
				<button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
					<span>打赏</span></button>
				<div id="QR" style="display: none;">
					
						<div id="wechat" style="display: inline-block">
							<a class="fancybox" rel="group">
								<img id="wechat_qr" src="/img/wechat.png" alt="WeChat Pay"></a>
							<p>微信</p>
						</div>
					
					
						<div id="alipay" style="display: inline-block">
							<a class="fancybox" rel="group">
								<img id="alipay_qr" src="/img/alipay.png" alt="Alipay"></a>
							<p>支付宝</p>
						</div>
					
				</div>
			</div>
	    
    

    </footer>


    
        <link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"integrity="sha384-n8MVd4RsNIU0tAv4ct0nTaAbDJwPJzDEaqSD1odI&#43;WdtXRGWt2kTvGFasHpSy3SV"crossorigin="anonymous"
            ><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"integrity="sha384-XjKyOOlGwcjNTAIQHIpgOno0Hl1YQqzUOEleOLALmuqehneUG&#43;vnGctmUb0ZY0l8"crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"integrity="sha384-&#43;VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4&#43;/RRE05"crossorigin="anonymous"
                defer
                >
            </script><script>
    window.addEventListener("DOMContentLoaded", () => {
	const mainArticleElement = document.querySelector(".main-article");
        renderMathInElement(mainArticleElement, {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ],
            ignoredClasses: ["gist"]
        });})
</script>

    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">相关文章</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="has-image">
    <a href="/p/kamailio-auth%E5%92%8Cauth_db%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/">
        
        
            <div class="article-image">
                <img src="/p/kamailio-auth%E5%92%8Cauth_db%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/backup.d79b25a7d32322529294e99537d12ff2_hu3700013637186254299.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post kamailio auth和auth_db模块介绍"
                        
                        data-hash="md5-15slp9MjIlKSlOmVN9Ev8g==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kamailio auth和auth_db模块介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/kamailio-exec%E5%92%8Cevrexec%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/">
        
        
            <div class="article-image">
                <img src="/p/kamailio-exec%E5%92%8Cevrexec%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/backup.0881c1d378a241e22b343eb677b5b43a_hu6234752795631963986.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post kamailio exec和evrexec模块介绍"
                        
                        data-hash="md5-CIHB03iiQeIrND62d7W0Og==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kamailio exec和evrexec模块介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/kamailio-acc%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/">
        
        
            <div class="article-image">
                <img src="/p/kamailio-acc%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/backup.28ecb48df5028eedb25c678b307078d7_hu8994354819087085260.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post kamailio acc模块介绍"
                        
                        data-hash="md5-KOy0jfUCju2yXGeLMHB41w==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kamailio acc模块介绍</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/kamailio%E7%9A%84%E7%BC%93%E5%AD%98htable/">
        
        
            <div class="article-image">
                <img src="/p/kamailio%E7%9A%84%E7%BC%93%E5%AD%98htable/backup.1eb5c90ec6888dc2e50d40d2c7ade367_hu8791573476009551332.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post kamailio的缓存HTable"
                        
                        data-hash="md5-HrXJDsaIjcLlDUDSx63jZw==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kamailio的缓存HTable</h2>
        </div>
    </a>
</article>

            
                
<article class="has-image">
    <a href="/p/kamailio-sipcapture%E4%BB%8B%E7%BB%8D/">
        
        
            <div class="article-image">
                <img src="/p/kamailio-sipcapture%E4%BB%8B%E7%BB%8D/backup.4989288e430ec75f87b6b2b0c8e48a84_hu6863806259171798440.jpg" 
                        width="250" 
                        height="150" 
                        loading="lazy"
                        alt="Featured image of post kamailio sipcapture介绍"
                        
                        data-hash="md5-SYkojkMOx1&#43;HtrKwyOSKhA==">
                
            </div>
        

        <div class="article-details">
            <h2 class="article-title">kamailio sipcapture介绍</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <link rel="stylesheet" href="https://unpkg.com/@waline/client@v3/dist/waline.css"/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script type="module">
    import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';
    init({"avatar":"","dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["https://cdn.jsdelivr.net/gh/walinejs/emojis/weibo"],"lang":"en","locale":{"admin":"Admin","reaction0":"非常有用","reaction1":"有帮助","reaction2":"一般","reaction3":"无帮助","reactionTitle":"这篇文章对你有帮助吗？"},"pageview":"true","placeholder":"","reaction":["https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili/bb_heart_eyes.png","https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili/bb_thumbsup.png","https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili/bb_zhoumei.png","https://npm.elemecdn.com/@waline/emojis@1.1.0/bilibili/bb_grievance.png"],"requiredMeta":["name"],"serverURL":"https://blog.xiaopeng.site:8364","visitor":"true"});
</script>

    

    <footer class="site-footer">
    <script type="module">
        import { pageviewCount } from 'https://unpkg.com/@waline/client@v3/dist/pageview.js';
        pageviewCount({
          serverURL: "https:\/\/blog.xiaopeng.site:8364"
        });
    </script>
    <script type="module">
        import { commentCount } from 'https://unpkg.com/@waline/client@v3/dist/comment.js';
        commentCount({
            serverURL: "https:\/\/blog.xiaopeng.site:8364"
        });
    </script>
    
    <section class="running-time">
    本博客已稳定运行
    <span id="runningdays" class="running-days"></span>
    </section>
    
    <section class="totalcount">
        
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
            
        
        
        发表了36篇文章 · 
        总计64.03k字
    </section>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span id="busuanzi_container_site_pv">本站总访问量 <span id="busuanzi_value_site_pv"></span> 次 · </span>
    <span id="busuanzi_container_site_uv">您是本站第 <span id="busuanzi_value_site_uv"></span> 位访问者</span>
    <section class="copyright">
        &copy; 
        
        2025 QuincyGao Blog
    </section>
    
    <section class="powerby">
        
        <a href="https://beian.miit.gov.cn/" target="_blank">粤ICP备2025368587号-1| </a>使用 <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> 构建 <br />
        主题 <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.29.0">Stack</a></b> 由 <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> 设计
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>


<script>
    let s1 = '2025-01-10'; 
    s1 = new Date(s1.replace(/-/g, "/"));
    let s2 = new Date();
    let timeDifference = s2.getTime() - s1.getTime();

    let days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
    let hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
    let minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));

    let result = days + "天" + hours + "小时" + minutes + "分钟";
    document.getElementById('runningdays').innerHTML = result;
</script>



<a href="#" id="back-to-top" title="返回顶部"></a>


<style>
  #back-to-top {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 55px;
    width: 55px;
    height: 55px;
    border-radius: 7px;
    background-color: rgba(64, 158, 255, 0.5);
    box-shadow: var(--shadow-l2);
    font-size: 30px;
    text-align: center;
    line-height: 50px;
    cursor: pointer;
  }

  #back-to-top:before {
    content: ' ';
    display: inline-block;
    position: relative;
    top: 0;
    transform: rotate(135deg);
    height: 10px;
    width: 10px;
    border-width: 0 0 2px 2px;
    border-color: var(--back-to-top-color);
    border-style: solid;
  }

  #back-to-top:hover:before {
    border-color: #2674e0;
  }

   
  @media screen and (max-width: 768px) {
    #back-to-top {
      bottom: 20px;
      right: 20px;
      width: 40px;
      height: 40px;
      font-size: 10px;
    }
  }

   
  @media screen and (min-width: 1024px) {
    #back-to-top {
      bottom: 20px;
      right: 40px;
    }
  }

   
  @media screen and (min-width: 1280px) {
    #back-to-top {
      bottom: 20px;
      right: 55px;
    }
  }

   
  @media screen and (min-width: 1536px) {
    #back-to-top {
      visibility: hidden;
    }
  }
</style>


<script>
  function backToTop() {
    document.documentElement.scrollIntoView({
      behavior: 'smooth',
    })
  }

  window.onload = function () {
    let scrollTop =
      this.document.documentElement.scrollTop || this.document.body.scrollTop
    let totopBtn = this.document.getElementById('back-to-top')
    if (scrollTop > 0) {
      totopBtn.style.display = 'inline'
    } else {
      totopBtn.style.display = 'none'
    }
  }

  window.onscroll = function () {
    let scrollTop =
      this.document.documentElement.scrollTop || this.document.body.scrollTop
    let totopBtn = this.document.getElementById('back-to-top')
    if (scrollTop < 200) {
      totopBtn.style.display = 'none'
    } else {
      totopBtn.style.display = 'inline'
      totopBtn.addEventListener('click', backToTop, false)
    }
  }
</script>

    </body>
</html>
