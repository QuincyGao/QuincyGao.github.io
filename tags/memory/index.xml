<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
    <channel>
        <title>Memory on QuincyGao Blog</title>
        <link>https://QuincyGao.github.io/tags/memory/</link>
        <description>Recent content in Memory on QuincyGao Blog</description>
        <generator>Hugo -- gohugo.io</generator>
        <language>zh-cn</language>
        <lastBuildDate>Fri, 14 Nov 2025 09:40:38 +0800</lastBuildDate><atom:link href="https://QuincyGao.github.io/tags/memory/index.xml" rel="self" type="application/rss+xml" /><item>
        <title>docker容器内存增长排查</title>
        <link>https://QuincyGao.github.io/p/docker%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E5%A2%9E%E9%95%BF%E6%8E%92%E6%9F%A5/</link>
        <pubDate>Fri, 14 Nov 2025 09:40:38 +0800</pubDate>
        
        <guid>https://QuincyGao.github.io/p/docker%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E5%A2%9E%E9%95%BF%E6%8E%92%E6%9F%A5/</guid>
        <description>&lt;img src="https://QuincyGao.github.io/p/docker%E5%AE%B9%E5%99%A8%E5%86%85%E5%AD%98%E5%A2%9E%E9%95%BF%E6%8E%92%E6%9F%A5/backup.jpg" alt="Featured image of post docker容器内存增长排查" /&gt;&lt;h2 id=&#34;背景&#34;&gt;背景
&lt;/h2&gt;&lt;p&gt;最近在把服务改造成&lt;code&gt;docker&lt;/code&gt;容器化，但是在压测中发现，使用&lt;code&gt;docker stats&lt;/code&gt;查看容器情况，发现内存一直在增长，
但是使用&lt;code&gt;ps -aux&lt;/code&gt;查看的&lt;code&gt;RSS(实际物理内存)&lt;/code&gt;内存占用是固定的，没有增长。针对此问题，现记录一下排查过程。&lt;/p&gt;
&lt;p&gt;主机系统是&lt;code&gt;CentOS 7.9.2009&lt;/code&gt;，&lt;code&gt;docker&lt;/code&gt;版本是&lt;code&gt;26.1.4&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;排查过程&#34;&gt;排查过程
&lt;/h2&gt;&lt;h3 id=&#34;基础知识&#34;&gt;基础知识
&lt;/h3&gt;&lt;p&gt;&lt;code&gt;docker stats&lt;/code&gt;统计的是&lt;code&gt;cgroup memory.usage_in_bytes&lt;/code&gt;,主要包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RSS&lt;/li&gt;
&lt;li&gt;程序未释放但是占用的虚拟内存(anonymous memory)&lt;/li&gt;
&lt;li&gt;Page Cache(文件缓存)&lt;/li&gt;
&lt;li&gt;Shmem(共享内存)&lt;/li&gt;
&lt;li&gt;tmpfs/overlayfs 缓冲区&lt;/li&gt;
&lt;li&gt;Mapped文件&lt;/li&gt;
&lt;li&gt;网络相关的buffer&lt;/li&gt;
&lt;li&gt;内核为容器分配的内存&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;code&gt;ps -aux&lt;/code&gt;查看的就是&lt;code&gt;RSS(实际物理内存)&lt;/code&gt;。&lt;/p&gt;
&lt;h3 id=&#34;开始排查&#34;&gt;开始排查
&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;查看容器的内存实际占用情况&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cat /sys/fs/cgroup/memory/docker/&amp;lt;container_id&amp;gt;/memory.stat 
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;需要注意的是&lt;code&gt;container_id&lt;/code&gt;是完整的，不是缩写。 我们使用&lt;code&gt;docker ps&lt;/code&gt;查看容器id时，默认显示的是缩写的id。&lt;/p&gt;
&lt;p&gt;第一次数据为：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cache 626470912
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;rss 32657408
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;rss_huge 20971520
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mapped_file 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;swap 69632
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgpgin 232273
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgpgout 76463
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgfault 111370
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgmajfault 45
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;inactive_anon 26267648
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;active_anon 6389760
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;inactive_file 278405120
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;active_file 348065792
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;unevictable 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;hierarchical_memory_limit 9223372036854771712
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;hierarchical_memsw_limit 9223372036854771712
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_cache 626470912
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_rss 32657408
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_rss_huge 20971520
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_mapped_file 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_swap 69632
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgpgin 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgpgout 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgfault 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgmajfault 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_inactive_anon 26267648
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_active_anon 6389760
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_inactive_file 278405120
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_active_file 348065792
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_unevictable 0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;第二次的数据：&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt; 1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 6
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 7
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 8
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt; 9
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;10
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;11
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;12
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;13
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;14
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;15
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;16
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;17
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;18
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;19
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;20
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;21
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;22
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;23
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;24
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;25
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;26
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;27
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;28
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;29
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;30
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;cache 667144192
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;rss 32940032
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;rss_huge 20971520
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;mapped_file 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;swap 69632
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgpgin 243250
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgpgout 77441
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgfault 113316
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;pgmajfault 45
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;inactive_anon 26267648
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;active_anon 6672384
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;inactive_file 291627008
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;active_file 375517184
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;unevictable 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;hierarchical_memory_limit 9223372036854771712
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;hierarchical_memsw_limit 9223372036854771712
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_cache 667144192
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_rss 32940032
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_rss_huge 20971520
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_mapped_file 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_swap 69632
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgpgin 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgpgout 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgfault 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_pgmajfault 0
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_inactive_anon 26267648
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_active_anon 6672384
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_inactive_file 291627008
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_active_file 375517184
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;total_unevictable 0
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;统计两次的差异为：&lt;/p&gt;
&lt;table&gt;
  &lt;thead&gt;
      &lt;tr&gt;
          &lt;th&gt;字段&lt;/th&gt;
          &lt;th&gt;snapshot1 (MB)&lt;/th&gt;
          &lt;th&gt;snapshot2 (MB)&lt;/th&gt;
          &lt;th&gt;diff (MB)&lt;/th&gt;
      &lt;/tr&gt;
  &lt;/thead&gt;
  &lt;tbody&gt;
      &lt;tr&gt;
          &lt;td&gt;cache（缓存）&lt;/td&gt;
          &lt;td&gt;597.652&lt;/td&gt;
          &lt;td&gt;636.128&lt;/td&gt;
          &lt;td&gt;38.476&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;rss（常驻内存）&lt;/td&gt;
          &lt;td&gt;31.129&lt;/td&gt;
          &lt;td&gt;31.426&lt;/td&gt;
          &lt;td&gt;0.297&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;pgpgin（内存页读入次数）&lt;/td&gt;
          &lt;td&gt;0.222&lt;/td&gt;
          &lt;td&gt;0.232&lt;/td&gt;
          &lt;td&gt;0.010&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;pgpgout（内存页写出次数）&lt;/td&gt;
          &lt;td&gt;0.073&lt;/td&gt;
          &lt;td&gt;0.074&lt;/td&gt;
          &lt;td&gt;0.001&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;pgfault（缺页次数）&lt;/td&gt;
          &lt;td&gt;0.106&lt;/td&gt;
          &lt;td&gt;0.108&lt;/td&gt;
          &lt;td&gt;0.002&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;active_anon（匿名活跃页）&lt;/td&gt;
          &lt;td&gt;6.094&lt;/td&gt;
          &lt;td&gt;6.362&lt;/td&gt;
          &lt;td&gt;0.268&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;inactive_file（文件未活跃页）&lt;/td&gt;
          &lt;td&gt;265.583&lt;/td&gt;
          &lt;td&gt;278.000&lt;/td&gt;
          &lt;td&gt;12.417&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;active_file（文件活跃页）&lt;/td&gt;
          &lt;td&gt;331.942&lt;/td&gt;
          &lt;td&gt;358.000&lt;/td&gt;
          &lt;td&gt;26.058&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;total_cache（总缓存）&lt;/td&gt;
          &lt;td&gt;597.652&lt;/td&gt;
          &lt;td&gt;636.128&lt;/td&gt;
          &lt;td&gt;38.476&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;total_rss（总常驻内存）&lt;/td&gt;
          &lt;td&gt;31.129&lt;/td&gt;
          &lt;td&gt;31.426&lt;/td&gt;
          &lt;td&gt;0.297&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;total_active_anon（总匿名活跃）&lt;/td&gt;
          &lt;td&gt;6.094&lt;/td&gt;
          &lt;td&gt;6.362&lt;/td&gt;
          &lt;td&gt;0.268&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;total_inactive_file（总文件未活跃）&lt;/td&gt;
          &lt;td&gt;265.583&lt;/td&gt;
          &lt;td&gt;278.000&lt;/td&gt;
          &lt;td&gt;12.417&lt;/td&gt;
      &lt;/tr&gt;
      &lt;tr&gt;
          &lt;td&gt;total_active_file（总文件活跃）&lt;/td&gt;
          &lt;td&gt;331.942&lt;/td&gt;
          &lt;td&gt;358.000&lt;/td&gt;
          &lt;td&gt;26.058&lt;/td&gt;
      &lt;/tr&gt;
  &lt;/tbody&gt;
&lt;/table&gt;
&lt;p&gt;可以看到：&lt;/p&gt;
&lt;p&gt;&lt;code&gt;cache/total_cache&lt;/code&gt;: 增长了38.476MB,&lt;/p&gt;
&lt;p&gt;&lt;code&gt;inactive_file&lt;/code&gt;: 增长了12.417MB,&lt;/p&gt;
&lt;p&gt;&lt;code&gt;active_file&lt;/code&gt;: 增长了26.058MB,总共就38.476MB, 说明文件&lt;code&gt;cache&lt;/code&gt;增多。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;rss/total_rss&lt;/code&gt;: 增长了0.297MB,可以忽略。&lt;/p&gt;
&lt;p&gt;这种 &lt;code&gt;cache&lt;/code&gt;的增长原因是:&lt;strong&gt;容器内频繁访问文件&lt;/strong&gt;,包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;日志文件&lt;/li&gt;
&lt;li&gt;overlay2 文件层&lt;/li&gt;
&lt;li&gt;配置文件&lt;/li&gt;
&lt;li&gt;静态文件&lt;/li&gt;
&lt;li&gt;访问volume&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;这个是&lt;strong&gt;正常情况&lt;/strong&gt;，内核会在内存不足时,自动回收。&lt;/p&gt;
&lt;p&gt;但是内存一直增长不是正常现象，需要进一步排查原因。&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;排查&lt;code&gt;cache&lt;/code&gt;增长的原因&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;在主机上临时清除缓存:&lt;/p&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;sync; echo 3 | sudo tee /proc/sys/vm/drop_caches
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;执行之后，可以发现&lt;code&gt;docker stats&lt;/code&gt;会瞬间下降到&lt;code&gt;RSS&lt;/code&gt;的大小。
因为我把日志挂载到了主机上, 基本可以确定是日志文件导致的&lt;code&gt;cache&lt;/code&gt;增长。&lt;/p&gt;
&lt;ol start=&#34;3&#34;&gt;
&lt;li&gt;如何解决&lt;/li&gt;
&lt;/ol&gt;
&lt;p&gt;原本是修改日志组件, 每次&lt;code&gt;Write&lt;/code&gt;之后就&lt;code&gt;Sync&lt;/code&gt;到磁盘, 但是改完之后效果不大，&lt;code&gt;Page Cache&lt;/code&gt;还是会增长。&lt;/p&gt;
&lt;p&gt;采用的方案有两种:&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;修改系统的内存回收机制：&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;/etc/sysctl.conf
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;vm.dirty_ratio = 10
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;vm.dirty_background_ratio = 5
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;vm.dirty_expire_centisecs = 500
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;vm.dirty_writeback_centisecs = 100
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;&lt;code&gt;sysctl -p&lt;/code&gt; 生效&lt;/p&gt;
&lt;p&gt;效果不太明显，增长的速度只是慢了一些，但是还是一直增长。&lt;/p&gt;
&lt;ol start=&#34;2&#34;&gt;
&lt;li&gt;是在&lt;code&gt;docker-compose.yaml&lt;/code&gt;中添加&lt;code&gt;mem_limit&lt;/code&gt;和&lt;code&gt;mem_reservation&lt;/code&gt;参数, 限制容器内存占用:&lt;/li&gt;
&lt;/ol&gt;
&lt;div class=&#34;highlight&#34;&gt;&lt;div class=&#34;chroma&#34;&gt;
&lt;table class=&#34;lntable&#34;&gt;&lt;tr&gt;&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code&gt;&lt;span class=&#34;lnt&#34;&gt;1
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;2
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;3
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;4
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;5
&lt;/span&gt;&lt;span class=&#34;lnt&#34;&gt;6
&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;
&lt;td class=&#34;lntd&#34;&gt;
&lt;pre tabindex=&#34;0&#34; class=&#34;chroma&#34;&gt;&lt;code class=&#34;language-fallback&#34; data-lang=&#34;fallback&#34;&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;deploy:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;      resources:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        limits:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          memory: 40M
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;        reservations:
&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;cl&#34;&gt;          memory: 20M
&lt;/span&gt;&lt;/span&gt;&lt;/code&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;
&lt;/div&gt;
&lt;/div&gt;&lt;p&gt;在测试中发现，设置的最大内存为&lt;code&gt;40M&lt;/code&gt;,程序的&lt;code&gt;RSS&lt;/code&gt;占用为&lt;code&gt;37M&lt;/code&gt;, 当&lt;code&gt;docker stats&lt;/code&gt;增长还没到&lt;code&gt;40M&lt;/code&gt;时(大概&lt;code&gt;35M&lt;/code&gt;)，
会主动回收&lt;code&gt;Page Cache&lt;/code&gt;。导致&lt;code&gt;docker stats&lt;/code&gt;的内存不会增长到&lt;code&gt;40M&lt;/code&gt;。&lt;/p&gt;
&lt;h2 id=&#34;总结&#34;&gt;总结
&lt;/h2&gt;&lt;ol&gt;
&lt;li&gt;当&lt;code&gt;RSS&lt;/code&gt;的大小不增长时，可以认定服务是没有内存泄漏问题。&lt;/li&gt;
&lt;li&gt;当&lt;code&gt;Page Cache&lt;/code&gt;的大小增长时，这类就需要设置系统层面上的内存回收机制，
限制容器内存占用，让其自动回收。&lt;/li&gt;
&lt;/ol&gt;
</description>
        </item>
        
    </channel>
</rss>
